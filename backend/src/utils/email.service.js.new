// src/utils/email.service.js
const { 
  sendEmail: brevoSendEmail,
  sendApprovalEmail,
  sendPasswordResetEmail 
} = require('./brevo.service');

/**
 * Envoie un email via l'API Brevo
 * @param {Object} mailOptions - Les options de l'email
 * @param {string} mailOptions.to - L'adresse email du destinataire
 * @param {string} mailOptions.subject - Le sujet de l'email
 * @param {string} mailOptions.html - Le contenu HTML de l'email
 * @param {string} [mailOptions.text] - Le contenu texte de l'email (optionnel)
 * @returns {Promise<Object>} - Un objet contenant les informations d'envoi
 */
const sendEmail = async (mailOptions) => {
  const { to, subject, html, text } = mailOptions;
  
  try {
    const result = await brevoSendEmail(to, subject, html, text);
    return {
      accepted: [to],
      rejected: [],
      envelope: { 
        from: process.env.BREVO_FROM_EMAIL || 'no-reply@votredomaine.com', 
        to: [to] 
      },
      messageId: result.messageId,
      response: '250 Message sent successfully'
    };
  } catch (error) {
    console.error('‚ùå Erreur lors de l\'envoi de l\'email:', error);
    throw error;
  }
};

/**
 * V√©rifie la connexion √† l'API Brevo
 * @returns {Promise<boolean>} - True si la connexion est √©tablie, false sinon
 */
const verifySMTP = async () => {
  console.log('üîç V√©rification de la connexion √† l\'API Brevo...');
  
  try {
    // V√©rification DNS
    const dns = require('dns');
    const dnsResult = await dns.promises.resolve('smtp-relay.brevo.com');
    console.log('‚úÖ R√©solution DNS r√©ussie:', dnsResult);
    
    // Test d'envoi d'email factice (mais avec une adresse invalide pour √©viter l'envoi r√©el)
    try {
      await sendEmail({
        to: 'test@example.com',
        subject: 'Test de connexion API Brevo',
        text: 'Ceci est un test de connexion',
        html: '<p>Ceci est un test de connexion</p>'
      });
    } catch (apiError) {
      // On s'attend √† une erreur car l'adresse est invalide, mais cela confirme que l'API est joignable
      if (apiError.message.includes('Invalid email address')) {
        console.log('‚úÖ Connexion √† l\'API Brevo r√©ussie');
        return true;
      }
      throw apiError;
    }
    
    return true;
  } catch (error) {
    console.error('‚ùå √âchec de la connexion √† l\'API Brevo:', {
      message: error.message,
      code: error.code,
      stack: error.stack
    });
    return false;
  }
};

// Exporter les fonctions pour maintenir la compatibilit√©
module.exports = {
  sendEmail,
  sendApprovalEmail,
  sendPasswordResetEmail,
  verifySMTP
};
